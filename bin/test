#!/bin/bash

PROTO=${TEST_PROTO:-http:}

if ! [[ "$PROTO" == *: ]]
then
  PROTO="$TEST_PROTO:"
fi

function die_on_failure {
  result=$?
  if [ $result -ne 0 ]
  then
    exit $result
  fi
}

if ! [ -n "$TEST_BROWSER_VISIBLE" ]
then
  export MOZ_HEADLESS=1
fi

rm -rf test-output/*
mkdir -p test-output
wget "$PROTO//$TEST_HOST/landregistry/query?query=SELECT * { ?s ?p ?o } LIMIT 1"
die_on_failure 'Test query failed'

tags=""

if [ "${RECENT}1" = '1' ]; then
  echo 'Running cucumber tests without @recent'
  tags="${tags}--tags \"not @recent\""
else
  echo 'Running cucumber tests, including @recent'
fi

if  [ -n "${IN_CI}" ]
then
  tags="${tags} --tags \"not @ci-exclude\""
  echo 'Running cucumber tests without @ci-exclude'
fi

eval "bundle exec cucumber $tags"
die_on_failure 'Cucumber test suite failed'

bundle exec rake test
die_on_failure 'Integration test suite failed'

if [ "$TEST_LB" != "true" ] 
then
  echo "running mod_qos test"

  echo "NOTE: this test will not work through a load balancer as it relies on being able to set X-FORWARDED-FOR"
  echo
  echo "To disable set environment variable TEST_LB=true"
  echo

  SCRIPTDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
  "$SCRIPTDIR/test-mod-qos"
  die_on_failure 'mod_qos test failed'
fi

